name: PKM-Universe Seed Finders Build
on: [push, workflow_dispatch]
permissions:
  contents: write
jobs:
  build:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'
      - name: Restore dependencies
        run: dotnet restore PKM-Universe-Seed-Finders.sln
      - name: Build All Plugins
        run: dotnet build PKM-Universe-Seed-Finders.sln -c Release --no-restore

      - name: Get Version with Revision
        id: version
        run: |
          $date = Get-Date -Format "yy.MM.dd"
          $baseTag = "v$date"

          # Get existing tags for today
          $existingTags = git tag -l "$baseTag*" 2>$null

          if ($existingTags) {
            # Find highest revision
            $maxRev = 0
            foreach ($tag in $existingTags) {
              if ($tag -match "rev\.(\d+)") {
                $rev = [int]$matches[1]
                if ($rev -gt $maxRev) { $maxRev = $rev }
              }
            }
            $newRev = $maxRev + 1
            $version = "$date-rev.$newRev"
          } else {
            $version = $date
          }

          echo "VERSION=$version" >> $env:GITHUB_OUTPUT
          echo "Version: $version"
        shell: pwsh

      - name: Create Plugins ZIP
        run: |
          mkdir ./release-plugins
          Copy-Item PLZASeedFinderPlugin/bin/Release/net9.0-windows/PLZASeedFinderPlugin.dll ./release-plugins/
          Copy-Item SVSeedFinderPlugin/bin/Release/net9.0-windows/SVSeedFinderPlugin.dll ./release-plugins/
          Copy-Item SWSHSeedFinderPlugin/bin/Release/net9.0-windows/SWSHSeedFinderPlugin.dll ./release-plugins/
          Compress-Archive -Path ./release-plugins/* -DestinationPath ./PKM-Universe-Seed-Finders-v${{ steps.version.outputs.VERSION }}.zip
        shell: pwsh

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.version.outputs.VERSION }}
          name: PKM-Universe Seed Finders v${{ steps.version.outputs.VERSION }}
          body: |
            ## üéØ PKM-Universe Seed Finder Plugins

            Complete collection of Seed Finder plugins for PKHeX!

            ### üì¶ Included Plugins
            | Plugin | Game |
            |--------|------|
            | `PLZASeedFinderPlugin.dll` | Pokemon Legends Z-A |
            | `SVSeedFinderPlugin.dll` | Pokemon Scarlet/Violet |
            | `SWSHSeedFinderPlugin.dll` | Pokemon Sword/Shield |

            ### üì• Installation
            1. Download individual DLLs or the full ZIP
            2. Place in your PKHeX `plugins` folder
            3. Restart PKHeX
            4. Find them in Tools menu

            ### ‚ú® Features
            - Find valid seeds for legal Pokemon generation
            - Supports shiny hunting with specific IVs
            - Works with PKHeX and PKM-Universe PKHeX

            ---
            Made with ‚ù§Ô∏è by PKM-Universe
          files: |
            ./PKM-Universe-Seed-Finders-v${{ steps.version.outputs.VERSION }}.zip
            PLZASeedFinderPlugin/bin/Release/net9.0-windows/PLZASeedFinderPlugin.dll
            SVSeedFinderPlugin/bin/Release/net9.0-windows/SVSeedFinderPlugin.dll
            SWSHSeedFinderPlugin/bin/Release/net9.0-windows/SWSHSeedFinderPlugin.dll
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - uses: actions/upload-artifact@v4
        with:
          name: PKM-Universe-Seed-Finders-v${{ steps.version.outputs.VERSION }}
          path: ./release-plugins/
